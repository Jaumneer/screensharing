<!DOCTYPE html>
<html>
<head>
    <title>İkinci Ekran</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #000; }
        video { width: 100%; height: 100%; }
        #status { position: absolute; top: 10px; left: 10px; color: #fff; font-family: sans-serif; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <video id="remoteVideo" autoplay playsinline muted></video>
    <div id="status">Bağlanıyor...</div>

    <script>
        const statusEl = document.getElementById('status');
        
        // Şifreleme yok, STUN yok - sadece lokal ağ
        const config = {
            iceServers: []
        };
        const pc = new RTCPeerConnection(config);

        pc.onconnectionstatechange = (event) => {
            const state = pc.connectionState;
            console.log(`WebRTC bağlantı durumu: ${state}`);
            statusEl.textContent = `Durum: ${state}`;
            
            if (state === 'connected') {
                statusEl.style.display = 'none';
            } else {
                statusEl.style.display = 'block';
            }
        };

        pc.oniceconnectionstatechange = (event) => {
            console.log(`ICE bağlantı durumu: ${pc.iceConnectionState}`);
        };

        pc.ontrack = (event) => {
            console.log("Sunucudan video track'i alındı:", event.track);
            const videoElement = document.getElementById('remoteVideo');
            videoElement.srcObject = event.streams[0];
            statusEl.textContent = 'Video alınıyor...';
        };

        async function startSession() {
            try {
                statusEl.textContent = 'Oturum başlatılıyor...';
                
                pc.addTransceiver('video', {'direction': 'recvonly'});
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                statusEl.textContent = 'Sunucuya bağlanılıyor...';
                
                const response = await fetch('/rtc', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pc.localDescription)
                });

                if (!response.ok) {
                    throw new Error(`HTTP hatası: ${response.status}`);
                }

                const answer = await response.json();
                await pc.setRemoteDescription(answer);
                
                statusEl.textContent = 'Bağlantı kuruldu, video bekleniyor...';
            } catch (e) {
                console.error("WebRTC oturumu başlatılırken hata oluştu:", e);
                statusEl.textContent = `Hata: ${e.message}`;
                statusEl.style.color = 'red';
            }
        }

        window.onload = startSession;
    </script>
</body>
</html>